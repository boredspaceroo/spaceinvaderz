<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>Wireframe Invaders</title>
  <style>
    *{margin:0;padding:0;box-sizing:border-box;touch-action:none}
    body{overflow:hidden;background:#000;font-family:monospace}
    canvas{display:block;width:100vw;height:100vh}
    #ui{position:fixed;top:20px;left:20px;color:#0ff;font-size:20px;text-shadow:0 0 10px #0ff;z-index:10;pointer-events:none}
    #msg{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);color:#0ff;font-size:32px;text-align:center;text-shadow:0 0 20px #0ff;z-index:20;pointer-events:none;opacity:0;transition:opacity .3s}
    #start{position:fixed;bottom:40px;left:50%;transform:translateX(-50%);padding:15px 40px;background:transparent;border:2px solid #0ff;color:#0ff;font-size:24px;cursor:pointer;text-shadow:0 0 10px #0ff;box-shadow:0 0 20px #0ff;z-index:30;font-family:monospace}
    #start:hover{background:#0ff;color:#000}
    .hide{display:none!important}
    #touch{position:fixed;bottom:0;left:0;right:0;height:200px;z-index:15;display:none}
    @media(max-width:768px){#ui{font-size:16px}#msg{font-size:24px}#start{font-size:18px;padding:12px 30px}}
  </style>
</head>
<body>
  <div id="ui">
    <div>SCORE: <span id="score">0</span></div>
    <div>STAGE: <span id="stage">1</span></div>
    <div>LIVES: <span id="lives">3</span></div>
  </div>
  <div id="msg"></div>
  <button id="start">START GAME</button>
  <div id="touch"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
  <script>
    'use strict';

    // Global variables
    var W = window.innerWidth;
    var H = window.innerHeight;
    var scene, camera, renderer, player;
    var bullets = [];
    var enemies = [];
    var particles = [];
    var score = 0;
    var lives = 3;
    var stage = 1;
    var gameActive = false;
    var keys = {};
    var touchX = 0;
    var audioCtx = null;
    var canPlayAudio = false;

    // --- Audio ---
    function playShoot() {
      if (!canPlayAudio || !audioCtx) return;
      try {
        var o = audioCtx.createOscillator();
        var g = audioCtx.createGain();
        o.connect(g);
        g.connect(audioCtx.destination);
        o.frequency.value = 400;
        g.gain.setValueAtTime(0.3, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.1);
        o.start();
        o.stop(audioCtx.currentTime + 0.1);
      } catch (e) {}
    }

    function playExplode() {
      if (!canPlayAudio || !audioCtx) return;
      try {
        var o = audioCtx.createOscillator();
        var g = audioCtx.createGain();
        o.connect(g);
        g.connect(audioCtx.destination);
        o.type = 'sawtooth';
        o.frequency.setValueAtTime(200, audioCtx.currentTime);
        o.frequency.exponentialRampToValueAtTime(50, audioCtx.currentTime + 0.3);
        g.gain.setValueAtTime(0.4, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        o.start();
        o.stop(audioCtx.currentTime + 0.3);
      } catch (e) {}
    }

    function playHit() {
      if (!canPlayAudio || !audioCtx) return;
      try {
        var o = audioCtx.createOscillator();
        var g = audioCtx.createGain();
        o.connect(g);
        g.connect(audioCtx.destination);
        o.frequency.value = 100;
        g.gain.setValueAtTime(0.5, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.2);
        o.start();
        o.stop(audioCtx.currentTime + 0.2);
      } catch (e) {}
    }

    function playStage() {
      if (!canPlayAudio || !audioCtx) return;
      try {
        var o = audioCtx.createOscillator();
        var g = audioCtx.createGain();
        o.connect(g);
        g.connect(audioCtx.destination);
        o.frequency.setValueAtTime(300, audioCtx.currentTime);
        o.frequency.setValueAtTime(500, audioCtx.currentTime + 0.1);
        o.frequency.setValueAtTime(700, audioCtx.currentTime + 0.2);
        g.gain.setValueAtTime(0.3, audioCtx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
        o.start();
        o.stop(audioCtx.currentTime + 0.3);
      } catch (e) {}
    }

    function initAudio() {
      try {
        var AC = window.AudioContext || window.webkitAudioContext;
        if (AC) {
          audioCtx = new AC();
          canPlayAudio = true;
        }
      } catch (e) {
        console.log('Audio not supported');
      }
    }

    // --- UI messages ---
    function showMsg(txt) {
      var m = document.getElementById('msg');
      m.innerHTML = txt;
      m.style.opacity = 1;
    }

    function hideMsg() {
      document.getElementById('msg').style.opacity = 0;
    }

    // --- Three.js init ---
    function init() {
      scene = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, W / H, 0.1, 1000);
      camera.position.z = 30;

      renderer = new THREE.WebGLRenderer({ antialias: true });
      renderer.setSize(W, H);
      renderer.setClearColor(0x000000);
      document.body.appendChild(renderer.domElement);

      // Create player ship (wireframe lines)
      var shipGeom = new THREE.BufferGeometry();
      var v = [
        0,0,0,  -1.5,-1,0,  1.5,-1,0,
        -1.5,-1,0,  -2,-1.5,0,  -1.5,-2,0,  -1,-1.5,0,
        1.5,-1,0,  2,-1.5,0,  1.5,-2,0,  1,-1.5,0,
        0,0,0,  0,0.5,0.5,  -0.3,-0.2,0.3,  0.3,-0.2,0.3,
        -1,-1.5,0,  -1,-1.5,-0.5,  -0.5,-1,-0.3,
        1,-1.5,0,  1,-1.5,-0.5,  0.5,-1,-0.3,
        -0.8,-0.8,0,  -0.6,-1.2,0,
        0.8,-0.8,0,  0.6,-1.2,0
      ];
      var idx = [
        0,1, 0,2, 1,2,
        3,4, 4,5, 5,6, 6,3,
        7,8, 8,9, 9,10, 10,7,
        11,12, 12,13, 13,14, 14,11,
        15,16, 16,17, 17,15,
        18,19, 19,20, 20,18,
        21,22, 23,24
      ];
      shipGeom.setAttribute('position', new THREE.Float32BufferAttribute(v, 3));
      shipGeom.setIndex(idx);

      var shipMat = new THREE.LineBasicMaterial({ color: 0x00ffff });
      player = new THREE.LineSegments(shipGeom, shipMat);
      player.position.y = -12;
      scene.add(player);

      setupInput();     // <-- important: renderer exists now
      animate();
    }

    // --- Input setup (must run after renderer is created) ---
    function setupInput() {
      // Keyboard
      document.addEventListener('keydown', function(e) {
        keys[e.key] = true;

        // prevent page scrolling on space
        if (e.key === ' ' || e.code === 'Space') e.preventDefault();

        if ((e.key === ' ' || e.code === 'Space') && gameActive) shoot();
      }, { passive: false });

      document.addEventListener('keyup', function(e) {
        keys[e.key] = false;
      });

      // Touch controls
      var touching = false;
      var touchEl = document.getElementById('touch');

      touchEl.addEventListener('touchstart', function(e) {
        if (!gameActive) return;
        touching = true;
        touchX = (e.touches[0].clientX / W) * 30 - 15;
        shoot();
      }, { passive: true });

      touchEl.addEventListener('touchmove', function(e) {
        if (!touching) return;
        e.preventDefault();
        touchX = (e.touches[0].clientX / W) * 30 - 15;
      }, { passive: false });

      touchEl.addEventListener('touchend', function() {
        touching = false;
        touchX = 0;
      }, { passive: true });

      // Mouse controls
      renderer.domElement.addEventListener('click', function() {
        if (gameActive) shoot();
      });

      renderer.domElement.addEventListener('mousemove', function(e) {
        if (gameActive) {
          player.position.x = (e.clientX / W) * 30 - 15;
        }
      });
    }

    // --- Game objects ---
    function createEnemies() {
      var rows = 3 + stage;
      var cols = 5 + Math.floor(stage / 2);
      var spacing = 3;
      var startX = -(cols - 1) * spacing / 2;
      var startY = 10;

      for (var r = 0; r < rows; r++) {
        for (var c = 0; c < cols; c++) {
          var geom = new THREE.BufferGeometry();
          var size = 0.8;
          var vv = [
            -size,size,0,  size,size,0,  size,-size,0,  -size,-size,0,
            0,size*1.5,0,
            -size*1.3,0,0,  size*1.3,0,0
          ];
          var ii = [0,1, 1,2, 2,3, 3,0, 0,4, 1,4, 3,5, 2,6];
          geom.setAttribute('position', new THREE.Float32BufferAttribute(vv, 3));
          geom.setIndex(ii);

          var mat = new THREE.LineBasicMaterial({ color: 0xff00ff });
          var enemy = new THREE.LineSegments(geom, mat);
          enemy.position.set(startX + c * spacing, startY - r * 2, 0);
          enemy.userData = {
            hp: 1 + Math.floor(stage / 3),
            speed: 0.02 * stage,
            dir: 1
          };
          scene.add(enemy);
          enemies.push(enemy);
        }
      }
    }

    function createParticles(x, y, color) {
      for (var k = 0; k < 20; k++) {
        var geom = new THREE.BufferGeometry();
        geom.setAttribute('position', new THREE.Float32BufferAttribute([0,0,0], 3));
        var mat = new THREE.PointsMaterial({ color: color, size: 0.2, transparent: true, opacity: 1 });
        var particle = new THREE.Points(geom, mat);
        particle.position.set(x, y, 0);
        particle.userData = {
          vx: (Math.random() - 0.5) * 0.3,
          vy: (Math.random() - 0.5) * 0.3,
          life: 30
        };
        scene.add(particle);
        particles.push(particle);
      }
    }

    function shoot() {
      if (!gameActive) return;
      var geom = new THREE.BufferGeometry();
      geom.setAttribute('position', new THREE.Float32BufferAttribute([0,0,0, 0,0.5,0], 3));
      var mat = new THREE.LineBasicMaterial({ color: 0x00ff00 });
      var bullet = new THREE.Line(geom, mat);
      bullet.position.copy(player.position);
      bullet.position.y += 1;
      scene.add(bullet);
      bullets.push(bullet);
      playShoot();
    }

    // --- Game flow ---
    function nextStage() {
      gameActive = false;
      stage++;
      document.getElementById('stage').textContent = stage;
      showMsg('STAGE ' + stage);
      playStage();

      setTimeout(function() {
        createEnemies();
        gameActive = true;
        hideMsg();
      }, 2000);
    }

    function gameOver() {
      gameActive = false;
      showMsg('GAME OVER<br>Score: ' + score);
      var btn = document.getElementById('start');
      btn.classList.remove('hide');
      btn.textContent = 'RESTART';
    }

    // --- Update loop ---
    function update() {
      if (!gameActive) return;

      // Player movement
      var speed = 0.5;
      if ((keys.ArrowLeft || keys.a || keys.A) && player.position.x > -15) {
        player.position.x -= speed;
      }
      if ((keys.ArrowRight || keys.d || keys.D) && player.position.x < 15) {
        player.position.x += speed;
      }
      if (touchX !== 0) {
        player.position.x += (touchX - player.position.x) * 0.1;
      }

      // Bullets
      for (var i = bullets.length - 1; i >= 0; i--) {
        var b = bullets[i];
        if (b.userData && b.userData.enemy) {
          b.position.y -= 0.4;
          if (b.position.y < -15) {
            scene.remove(b);
            bullets.splice(i, 1);
          }
        } else {
          b.position.y += 0.6;
          if (b.position.y > 20) {
            scene.remove(b);
            bullets.splice(i, 1);
          }
        }
      }

      // Enemies movement + shooting
      var edge = false;
      for (var j = 0; j < enemies.length; j++) {
        var e = enemies[j];
        e.position.x += e.userData.speed * e.userData.dir;
        if (Math.abs(e.position.x) > 18) edge = true;

        // Enemy shoots
        if (Math.random() < 0.001 * stage) {
          var g1 = new THREE.BufferGeometry();
          g1.setAttribute('position', new THREE.Float32BufferAttribute([0,0,0, 0,-0.5,0], 3));
          var m1 = new THREE.LineBasicMaterial({ color: 0xff0000 });
          var eb = new THREE.Line(g1, m1);
          eb.position.copy(e.position);
          eb.userData = { enemy: true };
          scene.add(eb);
          bullets.push(eb);
        }
      }

      if (edge) {
        for (var t = 0; t < enemies.length; t++) {
          enemies[t].userData.dir *= -1;
          enemies[t].position.y -= 0.5;
          if (enemies[t].position.y < -10) {
            gameOver();
            return;
          }
        }
      }

      // Collision detection
      for (var bi = bullets.length - 1; bi >= 0; bi--) {
        var bb = bullets[bi];
        if (bb.userData && bb.userData.enemy) {
          // Enemy bullet hits player
          if (Math.abs(bb.position.x - player.position.x) < 1 &&
              Math.abs(bb.position.y - player.position.y) < 1) {
            scene.remove(bb);
            bullets.splice(bi, 1);
            lives--;
            document.getElementById('lives').textContent = lives;
            createParticles(player.position.x, player.position.y, 0x00ffff);
            playHit();
            if (lives <= 0) gameOver();
          }
        } else {
          // Player bullet hits enemies
          for (var ei = enemies.length - 1; ei >= 0; ei--) {
            var ee = enemies[ei];
            if (Math.abs(bb.position.x - ee.position.x) < 1 &&
                Math.abs(bb.position.y - ee.position.y) < 1) {
              scene.remove(bb);
              bullets.splice(bi, 1);
              ee.userData.hp--;
              if (ee.userData.hp <= 0) {
                scene.remove(ee);
                enemies.splice(ei, 1);
                score += 10 * stage;
                document.getElementById('score').textContent = score;
                createParticles(ee.position.x, ee.position.y, 0xff00ff);
                playExplode();
                if (enemies.length === 0) nextStage();
              }
              break;
            }
          }
        }
      }

      // Particles
      for (var p = particles.length - 1; p >= 0; p--) {
        var pp = particles[p];
        pp.position.x += pp.userData.vx;
        pp.position.y += pp.userData.vy;
        pp.userData.life--;
        pp.material.opacity = pp.userData.life / 30;
        if (pp.userData.life <= 0) {
          scene.remove(pp);
          particles.splice(p, 1);
        }
      }
    }

    // --- Render loop ---
    function animate() {
      requestAnimationFrame(animate);
      update();
      renderer.render(scene, camera);
    }

    // --- Start game button ---
    document.getElementById('start').addEventListener('click', function() {
      // Initialize audio on user gesture
      if (!audioCtx) initAudio();
      if (audioCtx && audioCtx.state === 'suspended') {
        audioCtx.resume().catch(function(){});
      }

      // Reset game state
      if (scene) {
        for (var i = 0; i < bullets.length; i++) scene.remove(bullets[i]);
        for (var j = 0; j < enemies.length; j++) scene.remove(enemies[j]);
        for (var k = 0; k < particles.length; k++) scene.remove(particles[k]);
      }
      bullets = [];
      enemies = [];
      particles = [];
      score = 0;
      lives = 3;
      stage = 1;

      document.getElementById('score').textContent = '0';
      document.getElementById('lives').textContent = '3';
      document.getElementById('stage').textContent = '1';
      document.getElementById('start').classList.add('hide');

      player.position.set(0, -12, 0);
      createEnemies();
      gameActive = true;
      hideMsg();

      // Show touch controls on mobile
      if ('ontouchstart' in window) {
        document.getElementById('touch').style.display = 'block';
      }
    });

    // Resize handler
    window.addEventListener('resize', function() {
      W = window.innerWidth;
      H = window.innerHeight;
      camera.aspect = W / H;
      camera.updateProjectionMatrix();
      renderer.setSize(W, H);
    });

    // Init when DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }
  </script>
</body>
</html>
